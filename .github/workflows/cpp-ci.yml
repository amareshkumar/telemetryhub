name: C++ CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  smoke:
    name: Smoke (gateway_app --version)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build
      - name: Configure (Linux Debug preset)
        run: cmake --preset linux-ninja-debug
      - name: Build gateway_app only
        run: cmake --build --preset linux-ninja-debug --target gateway_app -v
      - name: Smoke run --version
        run: |
          if [ -f build/gateway/gateway_app ]; then build/gateway/gateway_app --version; fi
          if [ -f build/gateway_app ]; then build/gateway_app --version; fi
  linux:
    name: Linux (ASAN+UBSAN via Presets)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history for git describe)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build

      - name: Clean previous build dirs
        run: |
          rm -rf build build_asan build_tsan

      - name: Configure (Preset)
        run: cmake --preset linux-ninja-asan-ubsan

      - name: Build (Preset)
        run: cmake --build --preset linux-ninja-asan-ubsan -v

      - name: Tests (CTest Preset)
        run: ctest --preset linux-ninja-asan-ubsan --output-on-failure

      - name: "Smoke: gateway_app --version"
        run: |
          if [ -f build_asan/gateway/gateway_app ]; then build_asan/gateway/gateway_app --version; fi
          if [ -f build_asan/gateway_app ]; then build_asan/gateway_app --version; fi
  windows:
    name: Windows (MSVC via Presets)
    runs-on: windows-latest
    steps:
      - name: Checkout (full history for git describe)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Ninja
        run: choco install ninja -y

      - name: Configure (Preset)
        shell: bash
        run: cmake --preset vs2022-release-ci

      - name: Build (Preset)
        shell: bash
        run: cmake --build --preset vs2022-release-ci -v

      - name: Tests (CTest Preset)
        shell: bash
        run: ctest --preset vs2022-release-ci --output-on-failure

      - name: "Smoke: gateway_app --version"
        shell: bash
        run: |
          if [ -f build_vs_ci/gateway/Release/gateway_app.exe ]; then build_vs_ci/gateway/Release/gateway_app.exe --version; fi
          if [ -f build_vs_ci/gateway_app.exe ]; then build_vs_ci/gateway_app.exe --version; fi
  linux-tsan:
    name: Linux (TSan via Presets)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - run: sudo apt-get update && sudo apt-get install -y build-essential cmake ninja-build
      - name: Clean previous build dirs
        run: |
          rm -rf build build_asan build_tsan
      - run: cmake --preset linux-ninja-tsan
      - run: cmake --build --preset linux-ninja-tsan -v
      - run: ctest --preset linux-ninja-tsan --output-on-failure

  linux-release:
    name: Linux (Release via Presets)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - run: sudo apt-get update && sudo apt-get install -y build-essential cmake ninja-build
      - name: Clean previous build dirs
        run: |
          rm -rf build build_asan build_tsan
      - name: Configure (Linux Debug preset, use Release build)
        run: cmake --preset linux-ninja-debug
      - name: Build (Release config)
        run: cmake --build --preset linux-ninja-debug --config Release -v || cmake --build build -v
      - name: Tests (ctest Release)
        run: ctest --test-dir build -C Release --output-on-failure

