name: C++ CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  linux:
    name: Linux (ASAN+UBSAN via Presets)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history for git describe)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build

      - name: Clean previous build dirs
        run: |
          rm -rf build build_asan build_tsan

      - name: Configure (Preset)
        run: cmake --preset linux-ninja-asan-ubsan

      - name: Build (Preset)
        run: cmake --build --preset linux-ninja-asan-ubsan -v

      - name: Tests (CTest Preset)
        run: ctest --preset linux-ninja-asan-ubsan --output-on-failure

      - name: "Smoke: gateway_app --version"
        run: |
          if [ -f build_asan/gateway/gateway_app ]; then build_asan/gateway/gateway_app --version; fi
          if [ -f build_asan/gateway_app ]; then build_asan/gateway_app --version; fi
  windows:
    if: ${{ github.event_name != 'pull_request' }}
    name: Windows (MSVC via Presets)
    runs-on: windows-latest
    steps:
      - name: Checkout (full history for git describe)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Ninja
        run: choco install ninja -y

      - name: Configure (Preset)
        shell: bash
        run: cmake --preset vs2022-release-ci

      - name: Build (Preset)
        shell: bash
        run: cmake --build --preset vs2022-release-ci -v

      - name: Tests (CTest Preset, exclude flaky http_integration)
        shell: bash
        run: ctest --preset vs2022-release-ci --output-on-failure -E http_integration

      - name: "Smoke: gateway_app --version"
        shell: bash
        run: |
          if [ -f build_vs_ci/gateway/Release/gateway_app.exe ]; then build_vs_ci/gateway/Release/gateway_app.exe --version; fi
          if [ -f build_vs_ci/gateway_app.exe ]; then build_vs_ci/gateway_app.exe --version; fi
  windows-gui:
    if: ${{ github.event_name != 'pull_request' }}
    name: Windows GUI (Qt build)
    runs-on: windows-latest
    env:
      QT_HOST: windows
      QT_ARCH: msvc2022_64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Ninja
        run: choco install ninja -y

      - name: Install Qt
        id: install-qt
        uses: jurplel/install-qt-action@v4
        continue-on-error: true
        with:
          version: 6.10.1
          host: ${{ env.QT_HOST }}
          target: desktop
          arch: ${{ env.QT_ARCH }}
          cache: true

      - name: Fallback Install Qt 6.9.3
        if: steps.install-qt.outcome == 'failure'
        uses: jurplel/install-qt-action@v4
        with:
          version: 6.9.3
          host: ${{ env.QT_HOST }}
          target: desktop
          arch: ${{ env.QT_ARCH }}
          cache: true

      - name: "Guardrail: Verify Qt version is 6.10.1 or 6.9.3"
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not (Test-Path $env:Qt6_DIR)) {
            throw "Qt6_DIR not found at '$env:Qt6_DIR'"
          }
          Write-Host "Qt6_DIR found at $env:Qt6_DIR"
          Get-Command windeployqt.exe

      - name: Configure (GUI Preset VS2022)
        shell: bash
        run: cmake --preset vs2022-gui

      - name: Build GUI
        shell: bash
        run: cmake --build --preset vs2022-gui -v

      - name: Deploy Qt runtime with windeployqt
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $exeCandidates = @(
            "${{ github.workspace }}\\build_vs_gui\\gui\\Release\\gui_app.exe",
            "${{ github.workspace }}\\build_vs_gui\\Release\\gui_app.exe"
          )
          $app = $exeCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $app) { throw "gui_app.exe not found in expected locations" }
          Write-Host "Found GUI: $app"
          $qtBin = (Get-Command windeployqt6.exe -ErrorAction SilentlyContinue)?.Source
          if (-not $qtBin) { $qtBin = (Get-Command windeployqt.exe -ErrorAction SilentlyContinue)?.Source }
          if (-not $qtBin) { throw "windeployqt not found in PATH" }
          & $qtBin --release --compiler-runtime --verbose=1 "$app"
          # Create bundle dir and copy exe
          $bundle = "${{ github.workspace }}\\bundle_gui"
          New-Item -ItemType Directory -Force -Path $bundle | Out-Null
          Copy-Item -Force "$app" $bundle
          # Also copy deployed files (same folder as exe)
          $appDir = Split-Path -Parent "$app"
          Copy-Item -Recurse -Force "$appDir\\*.dll" $bundle -ErrorAction SilentlyContinue
          if (Test-Path "$appDir\\platforms") { Copy-Item -Recurse -Force "$appDir\\platforms" $bundle }
          if (Test-Path "$appDir\\styles") { Copy-Item -Recurse -Force "$appDir\\styles" $bundle }
          if (Test-Path "$appDir\\opengl32sw.dll") { Copy-Item -Force "$appDir\\opengl32sw.dll" $bundle }

      - name: Upload GUI bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: gui_app_windows_bundle
          path: bundle_gui
  linux-tsan:
    name: Linux (TSan via Presets)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - run: sudo apt-get update && sudo apt-get install -y build-essential cmake ninja-build
      - name: Clean previous build dirs
        run: |
          rm -rf build build_asan build_tsan
      - run: cmake --preset linux-ninja-tsan
      - run: cmake --build --preset linux-ninja-tsan -v
      - run: ctest --preset linux-ninja-tsan --output-on-failure

