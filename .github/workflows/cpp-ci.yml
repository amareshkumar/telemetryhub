name: C++ CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  linux:
    name: Linux (clang/gcc, ASAN+UBSAN)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history for git describe)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build

      - name: Configure
        run: cmake -S . -B build -G Ninja -DBUILD_TESTING=ON -DENABLE_ASAN=ON -DENABLE_UBSAN=ON

      - name: Build
        run: cmake --build build --config Debug -v

      - name: Tests (CTest)
        run: ctest --test-dir build --output-on-failure

      - name: "Smoke: gateway_app --version"
        run: |
          if [ -f build/gateway/gateway_app ]; then build/gateway/gateway_app --version; fi
          if [ -f build/gateway_app ]; then build/gateway_app --version; fi
  windows:
    name: Windows (MSVC)
    runs-on: windows-latest
    steps:
      - name: Checkout (full history for git describe)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Ninja
        run: choco install ninja -y

      - name: Configure (MSVC)
        shell: bash
        run: cmake -S . -B build -G Ninja -DBUILD_TESTING=ON

      - name: Build
        shell: bash
        run: cmake --build build --config Debug -v

      - name: Tests (CTest)
        shell: bash
        run: ctest --test-dir build --output-on-failure

      - name: "Smoke: gateway_app --version"
        shell: bash
        run: |
          if [ -f build/gateway/gateway_app.exe ]; then build/gateway/gateway_app.exe --version; fi
          if [ -f build/gateway_app.exe ]; then build/gateway_app.exe --version; fi
  linux-tsan:
    name: Linux (TSan)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - run: sudo apt-get update && sudo apt-get install -y build-essential cmake ninja-build
      - run: cmake -S . -B build-tsan -G Ninja -DBUILD_TESTING=ON -DENABLE_TSAN=ON -DENABLE_ASAN=OFF -DENABLE_UBSAN=OFF
      - run: cmake --build build-tsan --config Debug -v
      - run: ctest --test-dir build-tsan --output-on-failure

